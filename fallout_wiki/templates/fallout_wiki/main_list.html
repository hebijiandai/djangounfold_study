{% extends 'fallout_wiki/base.html' %}

{% block title %}联邦数据库 | Pip-Boy 3000 Mk IV{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <!-- Search and Per-Page Selector will go here -->
    <div class="cli-search-input-container d-flex align-items-center flex-grow-1 me-3">
        <input type="text" id="realtimeSearchInput" class="cli-search-input" placeholder="输入关键词搜索...">
        <span class="blinking-cursor">|</span>
    </div>

    <form action="{% url 'fallout_wiki:wiki_index' %}" method="get" id="perPageForm" class="d-flex align-items-center">
        <input type="hidden" name="tab" value="{{ active_tab }}">
        <label for="perPageSelect" class="me-2" style="white-space: nowrap;">每页显示:</label>
        <select class="form-select form-select-sm" id="perPageSelect" name="per_page" style="width: auto; background-color: var(--pip-boy-bg-darker); color: var(--pip-boy-green); border-color: var(--pip-boy-green);">
            {% for val in allowed_per_page %}
                <option value="{{ val }}" {% if val == per_page %}selected{% endif %}>{{ val }}</option>
            {% endfor %}
        </select>
    </form>
</div>


<!-- Tabs navs -->
<ul class="nav nav-tabs nav-justified mb-3" id="mainTab" role="tablist">
    <li class="nav-item" role="presentation">
        <a
        class="nav-link {% if active_tab == 'locations' %}active{% endif %}"
        id="locations-tab"
        data-mdb-tab-init
        href="#locations"
        role="tab"
        aria-controls="locations"
        aria-selected="{% if active_tab == 'locations' %}true{% else %}false{% endif %}"
        >地点 [{{ locations_page.paginator.count }}]</a
        >
    </li>
    <li class="nav-item" role="presentation">
        <a
        class="nav-link {% if active_tab == 'factions' %}active{% endif %}"
        id="factions-tab"
        data-mdb-tab-init
        href="#factions"
        role="tab"
        aria-controls="factions"
        aria-selected="{% if active_tab == 'factions' %}true{% else %}false{% endif %}"
        >派系 [{{ factions_page.paginator.count }}]</a
        >
    </li>
    <li class="nav-item" role="presentation">
        <a
        class="nav-link {% if active_tab == 'regions' %}active{% endif %}"
        id="regions-tab"
        data-mdb-tab-init
        href="#regions"
        role="tab"
        aria-controls="regions"
        aria-selected="{% if active_tab == 'regions' %}true{% else %}false{% endif %}"
        >区域 [{{ regions_page.paginator.count }}]</a
        >
    </li>
    <li class="nav-item" role="presentation">
        <a
        class="nav-link {% if active_tab == 'creatures' %}active{% endif %}"
        id="creatures-tab"
        data-mdb-tab-init
        href="#creatures"
        role="tab"
        aria-controls="creatures"
        aria-selected="{% if active_tab == 'creatures' %}true{% else %}false{% endif %}"
        >生物 [{{ creatures_page.paginator.count }}]</a
        >
    </li>
    <li class="nav-item" role="presentation">
        <a
        class="nav-link {% if active_tab == 'consumables' %}active{% endif %}"
        id="consumables-tab"
        data-mdb-tab-init
        href="#consumables"
        role="tab"
        aria-controls="consumables"
        aria-selected="{% if active_tab == 'consumables' %}true{% else %}false{% endif %}"
        >消耗品 [{{ consumables_page.paginator.count }}]</a
        >
    </li>
</ul>
<!-- Tabs navs -->

<!-- Tabs content -->
<div class="tab-content" id="mainTabContent">
    <div class="tab-pane fade {% if active_tab == 'locations' %}show active{% endif %}" id="locations" role="tabpanel" aria-labelledby="locations-tab">
        <div class="list-group">
            {% for item in locations_page %}<a href="{% url 'fallout_wiki:wiki_detail' model_name='location' pk=item.pk %}" class="list-group-item list-group-item-action">{{ item.name_cn }}</a>{% endfor %}
        </div>
        {% include 'fallout_wiki/pagination.html' with page_obj=locations_page query_param='locations_page' active_tab='locations' per_page=per_page %}
    </div>
    <div class="tab-pane fade {% if active_tab == 'factions' %}show active{% endif %}" id="factions" role="tabpanel" aria-labelledby="factions-tab">
        <div class="list-group">
            {% for item in factions_page %}<a href="{% url 'fallout_wiki:wiki_detail' model_name='faction' pk=item.pk %}" class="list-group-item list-group-item-action">{{ item.name }}</a>{% endfor %}
        </div>
        {% include 'fallout_wiki/pagination.html' with page_obj=factions_page query_param='factions_page' active_tab='factions' per_page=per_page %}
    </div>
    <div class="tab-pane fade {% if active_tab == 'regions' %}show active{% endif %}" id="regions" role="tabpanel" aria-labelledby="regions-tab">
        <div class="list-group">
            {% for item in regions_page %}<a href="{% url 'fallout_wiki:wiki_detail' model_name='region' pk=item.pk %}" class="list-group-item list-group-item-action">{{ item.name }}</a>{% endfor %}
        </div>
        {% include 'fallout_wiki/pagination.html' with page_obj=regions_page query_param='regions_page' active_tab='regions' per_page=per_page %}
    </div>
    <div class="tab-pane fade {% if active_tab == 'creatures' %}show active{% endif %}" id="creatures" role="tabpanel" aria-labelledby="creatures-tab">
        <div class="list-group">
            {% for item in creatures_page %}<a href="{% url 'fallout_wiki:wiki_detail' model_name='creature' pk=item.pk %}" class="list-group-item list-group-item-action">{{ item.name }}</a>{% endfor %}
        </div>
        {% include 'fallout_wiki/pagination.html' with page_obj=creatures_page query_param='creatures_page' active_tab='creatures' per_page=per_page %}
    </div>
    <div class="tab-pane fade {% if active_tab == 'consumables' %}show active{% endif %}" id="consumables" role="tabpanel" aria-labelledby="consumables-tab">
        <div class="list-group">
            {% for item in consumables_page %}<a href="{% url 'fallout_wiki:wiki_detail' model_name='consumable' pk=item.pk %}" class="list-group-item list-group-item-action">{{ item.name }}</a>{% endfor %}
        </div>
        {% include 'fallout_wiki/pagination.html' with page_obj=consumables_page query_param='consumables_page' active_tab='consumables' per_page=per_page %}
    </div>
</div>
<!-- Tabs content -->
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Per Page Selector Logic
    const perPageSelect = document.getElementById('perPageSelect');
    perPageSelect.addEventListener('change', () => {
        document.getElementById('perPageForm').submit();
    });

    const searchInput = document.getElementById('realtimeSearchInput');
    const tabContent = document.getElementById('mainTabContent');

    searchInput.addEventListener('keyup', () => {
        const searchTerm = searchInput.value.toLowerCase();
        
        const activeTabPane = tabContent.querySelector('.tab-pane.active');
        
        if (activeTabPane) {
            const listItems = activeTabPane.querySelectorAll('.list-group-item');
            
            listItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
    });

    const tabLinks = document.querySelectorAll('#mainTab .nav-link');
    tabLinks.forEach(link => {
        link.addEventListener('shown.mdb.tab', (event) => {
            const tabId = event.target.getAttribute('href').substring(1);
            const url = new URL(window.location);
            url.searchParams.set('tab', tabId);
            
            // Clear page numbers for other tabs to avoid conflicts
            ['locations_page', 'factions_page', 'regions_page', 'creatures_page', 'consumables_page'].forEach(p => {
                if (`${tabId}_page` !== p) {
                    url.searchParams.delete(p);
                }
            });

            history.pushState({}, '', url);
        });
    });

    // On page load, if there's a tab in the URL, activate it
    const urlParams = new URLSearchParams(window.location.search);
    const tabFromUrl = urlParams.get('tab');
    if (tabFromUrl) {
        const tabToActivate = document.querySelector(`#${tabFromUrl}-tab`);
        if (tabToActivate) {
            const tab = new mdb.Tab(tabToActivate);
            tab.show();
        }
    }
});
</script>
{% endblock %}